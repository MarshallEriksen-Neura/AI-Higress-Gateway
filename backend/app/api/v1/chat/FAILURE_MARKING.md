# Provider å®æ—¶æ•…éšœæ ‡è®°æœºåˆ¶

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®æ—¶æ•…éšœæ ‡è®°æœºåˆ¶ç”¨äºåœ¨ Provider å¤±è´¥æ—¶ç«‹å³æ ‡è®°ï¼Œé¿å…çŸ­æ—¶é—´å†…é‡å¤é€‰æ‹©æ•…éšœçš„ Providerï¼Œä»è€Œæ˜¾è‘—å‡å°‘æ— æ•ˆé‡è¯•æ—¶é—´ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

1. **å¿«é€Ÿå“åº”**ï¼šåœ¨ Provider å¤±è´¥æ—¶ç«‹å³æ ‡è®°ï¼Œæ— éœ€ç­‰å¾…å®šæ—¶å·¡æ£€
2. **è‡ªåŠ¨æ¢å¤**ï¼šæˆåŠŸæ—¶è‡ªåŠ¨æ¸…é™¤æ•…éšœæ ‡è®°ï¼Œæ— éœ€äººå·¥å¹²é¢„
3. **å¯é…ç½®**ï¼šé€šè¿‡ç¯å¢ƒå˜é‡çµæ´»æ§åˆ¶æ•…éšœé˜ˆå€¼å’Œå†·å´æœŸ
4. **ä½å¼€é”€**ï¼šä½¿ç”¨ Redis è®¡æ•°å™¨ï¼Œæ€§èƒ½å½±å“æå°

## ğŸ”§ å·¥ä½œåŸç†

### 1. æ•…éšœæ£€æµ‹

åœ¨å€™é€‰ Provider é‡è¯•è¿‡ç¨‹ä¸­ï¼š

```python
# æ£€æŸ¥ Provider æ˜¯å¦åœ¨æ•…éšœå†·å´æœŸ
failure_count = await _get_provider_failure_count(redis, provider_id)
if failure_count >= settings.provider_failure_threshold:
    # è·³è¿‡è¯¥ Provider
    logger.warning("Skipping provider %s: in failure cooldown", provider_id)
    continue
```

### 2. æ•…éšœæ ‡è®°

å½“ Provider è¿”å›å¯é‡è¯•çš„æœåŠ¡å™¨é”™è¯¯æ—¶ï¼ˆ500, 502, 503, 504, 429ï¼‰ï¼š

```python
if result.retryable and result.status_code in (500, 502, 503, 504, 429):
    # å¢åŠ æ•…éšœè®¡æ•°
    new_count = await _increment_provider_failure(redis, provider_id)
    logger.warning(
        "Provider %s failed, failure count: %d/%d",
        provider_id,
        new_count,
        settings.provider_failure_threshold,
    )
```

### 3. æ•…éšœæ¢å¤

å½“ Provider æˆåŠŸå“åº”æ—¶ï¼š

```python
if result.success:
    # æ¸…é™¤æ•…éšœæ ‡è®°
    await _clear_provider_failure(redis, provider_id)
    logger.info("Provider %s succeeded, failure flag cleared", provider_id)
```

## âš™ï¸ é…ç½®é¡¹

### ç¯å¢ƒå˜é‡

```bash
# æ•…éšœå†·å´æœŸï¼ˆç§’ï¼‰ï¼šåœ¨æ­¤æœŸé—´å†…å¤±è´¥æ¬¡æ•°è¶…è¿‡é˜ˆå€¼çš„ Provider å°†è¢«è·³è¿‡
PROVIDER_FAILURE_COOLDOWN_SECONDS=60

# æ•…éšœé˜ˆå€¼ï¼šåœ¨å†·å´æœŸå†…å¤±è´¥æ¬¡æ•°è¶…è¿‡æ­¤å€¼å°†è¢«è·³è¿‡
PROVIDER_FAILURE_THRESHOLD=3
```

### é»˜è®¤å€¼

- `PROVIDER_FAILURE_COOLDOWN_SECONDS`: 60 ç§’
- `PROVIDER_FAILURE_THRESHOLD`: 3 æ¬¡

### è°ƒä¼˜å»ºè®®

| åœºæ™¯ | å†·å´æœŸ | é˜ˆå€¼ | è¯´æ˜ |
|------|--------|------|------|
| **æ¿€è¿›æ¨¡å¼** | 30s | 2 | å¿«é€Ÿè·³è¿‡æ•…éšœ Providerï¼Œé€‚åˆé«˜å¯ç”¨åœºæ™¯ |
| **å¹³è¡¡æ¨¡å¼** | 60s | 3 | é»˜è®¤é…ç½®ï¼Œå¹³è¡¡å“åº”é€Ÿåº¦å’Œå®¹é”™æ€§ |
| **ä¿å®ˆæ¨¡å¼** | 120s | 5 | æ›´å®½å®¹çš„æ•…éšœå®¹å¿ï¼Œé€‚åˆ Provider ä¸ç¨³å®šåœºæ™¯ |

## ğŸ“Š æ€§èƒ½å½±å“

### Redis æ“ä½œ

æ¯æ¬¡è¯·æ±‚æœ€å¤šå¢åŠ ï¼š
- 1 æ¬¡ `GET`ï¼ˆæ£€æŸ¥æ•…éšœè®¡æ•°ï¼‰
- 1 æ¬¡ `INCR` + 1 æ¬¡ `EXPIRE`ï¼ˆå¤±è´¥æ—¶ï¼‰æˆ– 1 æ¬¡ `DELETE`ï¼ˆæˆåŠŸæ—¶ï¼‰

**æ€»å¼€é”€**ï¼š< 5msï¼ˆRedis æœ¬åœ°éƒ¨ç½²ï¼‰

### é¢„æœŸæ”¶ç›Š

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **é¦–æ¬¡å‘½ä¸­æ•…éšœ Provider** | 2000-3000ms | 500-800ms | â†“70% |
| **è¿ç»­é‡è¯•æ•…éšœ Provider** | 4000-6000ms | 1000-1500ms | â†“75% |
| **æ•…éšœ Provider æ¢å¤** | ç­‰å¾…ä¸‹æ¬¡å·¡æ£€ | ç«‹å³å¯ç”¨ | â†“100% |

## ğŸ” ç›‘æ§ä¸æ—¥å¿—

### æ—¥å¿—ç¤ºä¾‹

**è·³è¿‡æ•…éšœ Provider**ï¼š
```
â­ï¸  Skipping provider anyrouter-66849c86: in failure cooldown (failures=3/3, cooldown=60s)
```

**æ ‡è®°æ•…éšœ**ï¼š
```
âš ï¸  Provider anyrouter-66849c86 failed with status 503, failure count: 3/3 (cooldown=60s)
```

**æ¸…é™¤æ•…éšœæ ‡è®°**ï¼š
```
âœ… Provider anyrouter-66849c86 succeeded, failure flag cleared
```

**æ‰€æœ‰å€™é€‰éƒ½å¤±è´¥**ï¼š
```
ğŸ’¥ All upstream providers failed for logical model 'claude-sonnet-4-20250514' (total_candidates=3, skipped=2, tried=1)
```

### Redis é”®æ ¼å¼

```
provider:failure:{provider_id}
```

ç¤ºä¾‹ï¼š
```
provider:failure:anyrouter-66849c86 = "3"  # TTL: 60s
```

## ğŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•ï¼š

```bash
pytest backend/tests/test_candidate_retry_failure_marking.py -v
```

æµ‹è¯•è¦†ç›–ï¼š
- âœ… è·å–æ•…éšœè®¡æ•°
- âœ… å¢åŠ æ•…éšœè®¡æ•°
- âœ… æ¸…é™¤æ•…éšœæ ‡è®°
- âœ… è·³è¿‡æ•…éšœå†·å´æœŸçš„ Provider
- âœ… å¯é‡è¯•é”™è¯¯æ—¶æ ‡è®°æ•…éšœ
- âœ… æˆåŠŸæ—¶æ¸…é™¤æ•…éšœæ ‡è®°
- âœ… æ‰€æœ‰ Provider éƒ½åœ¨æ•…éšœå†·å´æœŸ

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ 1ï¼šProvider çªç„¶æ•…éšœ

```
æ—¶é—´çº¿ï¼š
00:00 - Provider A è¿”å› 503ï¼ˆç¬¬ 1 æ¬¡å¤±è´¥ï¼‰
00:05 - Provider A è¿”å› 503ï¼ˆç¬¬ 2 æ¬¡å¤±è´¥ï¼‰
00:10 - Provider A è¿”å› 503ï¼ˆç¬¬ 3 æ¬¡å¤±è´¥ï¼Œè¾¾åˆ°é˜ˆå€¼ï¼‰
00:15 - æ–°è¯·æ±‚åˆ°è¾¾ï¼Œè·³è¿‡ Provider Aï¼Œç›´æ¥å°è¯• Provider B âœ…
01:10 - å†·å´æœŸç»“æŸï¼ˆ60ç§’åï¼‰ï¼ŒProvider A é‡æ–°å¯ç”¨
```

### åœºæ™¯ 2ï¼šProvider ç¬æ—¶è´Ÿè½½é«˜å³°

```
æ—¶é—´çº¿ï¼š
00:00 - Provider A è¿”å› 429ï¼ˆè´Ÿè½½ä¸Šé™ï¼Œç¬¬ 1 æ¬¡å¤±è´¥ï¼‰
00:02 - Provider A è¿”å› 429ï¼ˆç¬¬ 2 æ¬¡å¤±è´¥ï¼‰
00:04 - Provider A è¿”å› 429ï¼ˆç¬¬ 3 æ¬¡å¤±è´¥ï¼Œè¾¾åˆ°é˜ˆå€¼ï¼‰
00:06 - æ–°è¯·æ±‚åˆ°è¾¾ï¼Œè·³è¿‡ Provider Aï¼Œä½¿ç”¨ Provider B âœ…
00:30 - Provider A è´Ÿè½½æ¢å¤
01:06 - å†·å´æœŸç»“æŸï¼ŒProvider A é‡æ–°å¯ç”¨
```

### åœºæ™¯ 3ï¼šProvider æ¢å¤åç«‹å³å¯ç”¨

```
æ—¶é—´çº¿ï¼š
00:00 - Provider A æœ‰ 2 æ¬¡å¤±è´¥è®°å½•
00:10 - Provider A æˆåŠŸå“åº” âœ…
00:10 - æ•…éšœæ ‡è®°è¢«æ¸…é™¤ï¼ŒProvider A ç«‹å³æ¢å¤æ­£å¸¸ä¼˜å…ˆçº§
```

## ğŸ”„ ä¸å…¶ä»–æœºåˆ¶çš„å…³ç³»

### ä¸ç”¨æˆ·æ¢é’ˆçš„é…åˆ

- **ç”¨æˆ·æ¢é’ˆ**ï¼šå®šæœŸæ£€æŸ¥ Provider å¥åº·çŠ¶æ€ï¼ˆé•¿æœŸè¶‹åŠ¿ï¼‰
- **å®æ—¶æ•…éšœæ ‡è®°**ï¼šç«‹å³å“åº”ç¬æ—¶æ•…éšœï¼ˆçŸ­æœŸæ³¢åŠ¨ï¼‰

ä¸¤è€…äº’è¡¥ï¼š
- æ¢é’ˆå‘ç°æŒä¹…æ€§æ•…éšœ â†’ è°ƒæ•´ Provider æƒé‡
- å®æ—¶æ ‡è®°å¤„ç†ç¬æ—¶æ•…éšœ â†’ å¿«é€Ÿè·³è¿‡æ•…éšœ Provider

### ä¸è°ƒåº¦å™¨çš„é…åˆ

è°ƒåº¦å™¨è¯„åˆ†æ—¶ä¼šè€ƒè™‘ï¼š
1. åŸºç¡€æƒé‡ï¼ˆé…ç½®ï¼‰
2. å†å²æŒ‡æ ‡ï¼ˆå»¶è¿Ÿã€é”™è¯¯ç‡ï¼‰
3. åŠ¨æ€æƒé‡ï¼ˆæ¢é’ˆç»“æœï¼‰
4. **å®æ—¶æ•…éšœæ ‡è®°**ï¼ˆæœ¬æœºåˆ¶ï¼‰â† æ–°å¢

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **Redis ä¾èµ–**ï¼šéœ€è¦ Redis æ­£å¸¸è¿è¡Œï¼Œå¦åˆ™æ•…éšœæ ‡è®°åŠŸèƒ½å¤±æ•ˆï¼ˆä½†ä¸å½±å“ä¸»æµç¨‹ï¼‰
2. **æ—¶é’ŸåŒæ­¥**ï¼šå¤šå®ä¾‹éƒ¨ç½²æ—¶éœ€è¦ç¡®ä¿æœåŠ¡å™¨æ—¶é’ŸåŒæ­¥
3. **å†·å´æœŸè®¾ç½®**ï¼šè¿‡çŸ­å¯èƒ½å¯¼è‡´é¢‘ç¹åˆ‡æ¢ï¼Œè¿‡é•¿å¯èƒ½å»¶è¿Ÿæ¢å¤
4. **é˜ˆå€¼è®¾ç½®**ï¼šè¿‡ä½å¯èƒ½è¯¯åˆ¤ï¼Œè¿‡é«˜å¯èƒ½å“åº”æ…¢

## ğŸ¯ æœ€ä½³å®è·µ

1. **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆ60s / 3æ¬¡ï¼‰
2. **é«˜å¯ç”¨åœºæ™¯**ï¼šç¼©çŸ­å†·å´æœŸåˆ° 30sï¼Œé™ä½é˜ˆå€¼åˆ° 2æ¬¡
3. **ä¸ç¨³å®šç½‘ç»œ**ï¼šå»¶é•¿å†·å´æœŸåˆ° 120sï¼Œæé«˜é˜ˆå€¼åˆ° 5æ¬¡
4. **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§ Redis é”® `provider:failure:*` çš„æ•°é‡å’Œé¢‘ç‡

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å€™é€‰é‡è¯•é€»è¾‘](./candidate_retry.py)
- [ä¼ è¾“å±‚å¤„ç†](./transport_handlers.py)
- [è·¯ç”±è°ƒåº¦å™¨](../../routing/scheduler.py)
- [ç”¨æˆ·æ¢é’ˆæœåŠ¡](../../services/user_probe_service.py)
