# 任务 11 手动测试指南：健康状态徽章

## 测试目标
验证系统页的健康状态徽章是否正确显示，并根据 KPI 数据动态更新颜色和文案。

## 前置条件
1. 启动后端服务（确保 `/metrics/v2/system-dashboard/kpis` 接口可用）
2. 启动前端开发服务器：`cd frontend && npm run dev`
3. 使用管理员账号登录系统

## 测试步骤

### 测试 1：页面加载和徽章显示
1. 访问系统仪表盘页面：`http://localhost:3000/dashboard/system`
2. **预期结果**：
   - ✅ 页面顶部显示"系统仪表盘"标题
   - ✅ 标题右侧显示健康状态徽章
   - ✅ 徽章位置在标题和筛选器之间
   - ✅ 徽章使用 Badge 组件样式（圆角、边框）

### 测试 2：加载状态
1. 刷新页面，观察徽章的初始状态
2. **预期结果**：
   - ✅ 数据加载时显示灰色占位符徽章
   - ✅ 徽章文案显示"加载中..."（中文）或"Loading..."（英文）
   - ✅ 徽章有脉冲动画效果（animate-pulse）

### 测试 3：正常状态（绿色徽章）
**模拟条件**：错误率 < 1% 且 P95 延迟 < 1000ms

1. 确保系统运行正常（低错误率、低延迟）
2. 观察健康状态徽章
3. **预期结果**：
   - ✅ 徽章显示绿色背景
   - ✅ 徽章文案显示"正常"（中文）或"Normal"（英文）
   - ✅ 暗色模式下颜色正确（深绿色背景，浅绿色文字）

**测试数据示例**：
- errorRate: 0.5%
- latencyP95Ms: 800ms
- 预期徽章：🟢 正常

### 测试 4：抖动状态（黄色徽章）
**模拟条件**：错误率在 1-5% 或 P95 延迟在 1000-3000ms

#### 场景 4.1：错误率导致抖动
1. 模拟错误率升高（1-5%）
2. 观察健康状态徽章
3. **预期结果**：
   - ✅ 徽章显示黄色背景
   - ✅ 徽章文案显示"抖动"（中文）或"Degraded"（英文）

**测试数据示例**：
- errorRate: 2.5%
- latencyP95Ms: 500ms
- 预期徽章：🟡 抖动

#### 场景 4.2：延迟导致抖动
1. 模拟延迟升高（1000-3000ms）
2. 观察健康状态徽章
3. **预期结果**：
   - ✅ 徽章显示黄色背景
   - ✅ 徽章文案显示"抖动"（中文）或"Degraded"（英文）

**测试数据示例**：
- errorRate: 0.5%
- latencyP95Ms: 1500ms
- 预期徽章：🟡 抖动

### 测试 5：异常状态（红色徽章）
**模拟条件**：错误率 > 5% 或 P95 延迟 > 3000ms

#### 场景 5.1：错误率导致异常
1. 模拟高错误率（> 5%）
2. 观察健康状态徽章
3. **预期结果**：
   - ✅ 徽章显示红色背景
   - ✅ 徽章文案显示"异常"（中文）或"Unhealthy"（英文）

**测试数据示例**：
- errorRate: 8.0%
- latencyP95Ms: 500ms
- 预期徽章：🔴 异常

#### 场景 5.2：延迟导致异常
1. 模拟极高延迟（> 3000ms）
2. 观察健康状态徽章
3. **预期结果**：
   - ✅ 徽章显示红色背景
   - ✅ 徽章文案显示"异常"（中文）或"Unhealthy"（英文）

**测试数据示例**：
- errorRate: 0.5%
- latencyP95Ms: 3500ms
- 预期徽章：🔴 异常

### 测试 6：筛选器变化时的徽章更新
1. 切换时间范围筛选器（today / 7d / 30d）
2. 观察健康状态徽章是否更新
3. **预期结果**：
   - ✅ 徽章根据新的 KPI 数据更新颜色和文案
   - ✅ 更新过程流畅，无闪烁

### 测试 7：传输方式筛选器变化
1. 切换传输方式筛选器（all / http / sdk / claude_cli）
2. 观察健康状态徽章是否更新
3. **预期结果**：
   - ✅ 徽章根据筛选后的 KPI 数据更新
   - ✅ 不同传输方式可能有不同的健康状态

### 测试 8：流式筛选器变化
1. 切换流式筛选器（all / true / false）
2. 观察健康状态徽章是否更新
3. **预期结果**：
   - ✅ 徽章根据筛选后的 KPI 数据更新
   - ✅ 流式和非流式请求可能有不同的健康状态

### 测试 9：响应式布局
#### 桌面端（≥1024px）
1. 在桌面浏览器中打开页面
2. **预期结果**：
   - ✅ 标题和徽章在同一行
   - ✅ 筛选器在右侧
   - ✅ 布局横向排列

#### 平板端（768-1023px）
1. 调整浏览器窗口到平板尺寸
2. **预期结果**：
   - ✅ 标题和徽章在同一行
   - ✅ 筛选器可能换行
   - ✅ 布局适应屏幕宽度

#### 移动端（<768px）
1. 调整浏览器窗口到移动设备尺寸
2. **预期结果**：
   - ✅ 标题和徽章在同一行
   - ✅ 筛选器在下一行
   - ✅ 布局纵向排列

### 测试 10：暗色模式
1. 切换到暗色模式
2. 观察健康状态徽章的颜色
3. **预期结果**：
   - ✅ 正常状态：深绿色背景，浅绿色文字
   - ✅ 抖动状态：深黄色背景，浅黄色文字
   - ✅ 异常状态：深红色背景，浅红色文字
   - ✅ 徽章边框颜色适配暗色模式

### 测试 11：国际化
#### 中文
1. 切换语言到中文
2. **预期结果**：
   - ✅ 加载中：显示"加载中..."
   - ✅ 正常：显示"正常"
   - ✅ 抖动：显示"抖动"
   - ✅ 异常：显示"异常"

#### 英文
1. 切换语言到英文
2. **预期结果**：
   - ✅ 加载中：显示"Loading..."
   - ✅ 正常：显示"Normal"
   - ✅ 抖动：显示"Degraded"
   - ✅ 异常：显示"Unhealthy"

### 测试 12：错误处理
1. 模拟 API 请求失败（断开网络或后端服务）
2. 观察健康状态徽章的行为
3. **预期结果**：
   - ✅ 徽章使用默认值（errorRate = 0, latencyP95Ms = 0）
   - ✅ 显示"正常"状态（因为默认值都是 0）
   - ✅ 不会崩溃或显示错误

## 健康状态判断逻辑参考

```
正常（绿色）：
  - 错误率 < 1% AND P95 延迟 < 1000ms

抖动（黄色）：
  - 错误率 >= 1% AND 错误率 <= 5%
  - OR P95 延迟 >= 1000ms AND P95 延迟 <= 3000ms

异常（红色）：
  - 错误率 > 5%
  - OR P95 延迟 > 3000ms
```

## 测试数据矩阵

| 错误率 | P95 延迟 | 预期状态 | 预期颜色 | 预期文案（中文） |
|--------|----------|----------|----------|------------------|
| 0.5%   | 800ms    | 正常     | 🟢 绿色  | 正常             |
| 0.8%   | 950ms    | 正常     | 🟢 绿色  | 正常             |
| 1.0%   | 500ms    | 抖动     | 🟡 黄色  | 抖动             |
| 2.5%   | 800ms    | 抖动     | 🟡 黄色  | 抖动             |
| 0.5%   | 1500ms   | 抖动     | 🟡 黄色  | 抖动             |
| 3.0%   | 2000ms   | 抖动     | 🟡 黄色  | 抖动             |
| 6.0%   | 500ms    | 异常     | 🔴 红色  | 异常             |
| 0.5%   | 3500ms   | 异常     | 🔴 红色  | 异常             |
| 8.0%   | 4000ms   | 异常     | 🔴 红色  | 异常             |

## 常见问题排查

### 问题 1：徽章不显示
**可能原因**：
- 组件导入路径错误
- 权限检查失败（非管理员用户）
- CSS 样式冲突

**排查步骤**：
1. 检查浏览器控制台是否有错误
2. 检查网络请求是否成功
3. 检查用户是否有管理员权限

### 问题 2：徽章颜色不正确
**可能原因**：
- KPI 数据格式错误
- 健康状态逻辑错误
- CSS 样式被覆盖

**排查步骤**：
1. 检查 KPI 数据的 errorRate 和 latencyP95Ms 值
2. 检查 deriveHealthStatus 函数的逻辑
3. 检查 Tailwind CSS 类名是否正确应用

### 问题 3：徽章不更新
**可能原因**：
- SWR 缓存未失效
- 筛选器状态未正确传递
- React 组件未重新渲染

**排查步骤**：
1. 检查 useMemo 依赖项是否正确
2. 检查 SWR Hook 的 key 是否变化
3. 使用 React DevTools 检查组件状态

## 测试完成标准

✅ 所有 12 个测试场景都通过  
✅ 徽章在不同状态下显示正确的颜色和文案  
✅ 徽章响应筛选器变化  
✅ 徽章支持响应式布局  
✅ 徽章支持暗色模式  
✅ 徽章支持国际化  
✅ 徽章正确处理加载和错误状态  

## 测试报告模板

```
测试日期：____________________
测试人员：____________________
浏览器：____________________
屏幕尺寸：____________________

测试结果：
- [ ] 测试 1：页面加载和徽章显示
- [ ] 测试 2：加载状态
- [ ] 测试 3：正常状态
- [ ] 测试 4：抖动状态
- [ ] 测试 5：异常状态
- [ ] 测试 6：筛选器变化
- [ ] 测试 7：传输方式筛选器
- [ ] 测试 8：流式筛选器
- [ ] 测试 9：响应式布局
- [ ] 测试 10：暗色模式
- [ ] 测试 11：国际化
- [ ] 测试 12：错误处理

发现的问题：
1. ____________________
2. ____________________

总体评价：____________________
```
