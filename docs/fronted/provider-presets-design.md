# 提供商预设管理页面设计文档

## 1. 概述

提供商预设管理页面允许管理员创建、编辑和管理官方提供商预设配置。这些预设可以被用户在创建私有提供商时选择使用，简化配置流程。

## 2. 页面路径

- **路径**: `/dashboard/provider-presets`
- **权限**: 仅限超级管理员访问
- **导航位置**: Dashboard 侧边栏，与 Providers 页面同级

## 3. 功能需求

### 3.1 核心功能
1. **列表展示**: 显示所有提供商预设，包括关键信息
2. **创建预设**: 通过表单创建新的提供商预设
3. **编辑预设**: 修改现有预设的配置
4. **删除预设**: 删除不再需要的预设（需二次确认）
5. **查看详情**: 展示预设的完整配置信息

### 3.2 数据字段

#### 必填字段
- `preset_id`: 预设唯一标识符（字符串，1-50字符）
- `display_name`: 显示名称（字符串，最大100字符）
- `base_url`: API基础URL
- `provider_type`: 提供商类型（native/aggregator）
- `transport`: 传输方式（http/sdk）

#### 可选字段
- `description`: 描述信息（最大2000字符）
- `models_path`: 模型列表路径（默认: /v1/models）
- `messages_path`: 消息路径（默认: /v1/message）
- `chat_completions_path`: 聊天完成路径（默认: /v1/chat/completions）
- `responses_path`: 响应路径
- `supported_api_styles`: 支持的API风格数组（openai/responses/claude）
- `retryable_status_codes`: 可重试的HTTP状态码数组
- `custom_headers`: 自定义请求头（JSON对象）
- `static_models`: 静态模型列表（JSON数组）

## 4. UI设计

### 4.1 页面布局

```
┌─────────────────────────────────────────────────────────┐
│ 提供商预设管理                    [+ 创建预设] 按钮      │
│ 管理官方提供商预设配置                                   │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌────────────────────────────────────────────────┐    │
│  │ 预设列表表格                                    │    │
│  │ ┌──────┬────────┬──────────┬────────┬────────┐ │    │
│  │ │预设ID│显示名称│提供商类型│传输方式│操作    │ │    │
│  │ ├──────┼────────┼──────────┼────────┼────────┤ │    │
│  │ │openai│OpenAI  │Native    │HTTP    │编辑删除│ │    │
│  │ │claude│Claude  │Native    │SDK     │编辑删除│ │    │
│  │ └──────┴────────┴──────────┴────────┴────────┘ │    │
│  └────────────────────────────────────────────────┘    │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 4.2 表格列定义

| 列名 | 宽度 | 说明 |
|------|------|------|
| 预设ID | 15% | preset_id，主键 |
| 显示名称 | 20% | display_name |
| 基础URL | 25% | base_url，截断显示 |
| 提供商类型 | 12% | provider_type，带标签 |
| 传输方式 | 10% | transport，带标签 |
| 创建时间 | 13% | created_at，相对时间 |
| 操作 | 5% | 编辑、删除按钮 |

### 4.3 创建/编辑表单

表单采用对话框（Dialog）形式，分为基础配置和高级配置两个标签页：

#### 基础配置标签
- 预设ID（创建时必填，编辑时只读）
- 显示名称
- 描述
- 基础URL
- 提供商类型（单选：Native/Aggregator）
- 传输方式（单选：HTTP/SDK）

#### 高级配置标签
- 模型路径
- 消息路径
- 聊天完成路径
- 响应路径
- 支持的API风格（多选）
- 可重试状态码（标签输入）
- 自定义请求头（JSON编辑器）
- 静态模型列表（JSON编辑器）

### 4.4 交互流程图

#### 创建预设流程
1. 点击创建预设按钮
2. 打开表单对话框
3. 填写基础配置
4. 可选：切换到高级配置标签填写高级选项
5. 点击提交
6. 表单验证
7. 调用API创建
8. 成功：刷新列表并显示成功提示
9. 失败：显示错误信息

#### 编辑预设流程
1. 点击编辑按钮
2. 加载预设数据
3. 打开表单对话框并填充数据
4. 修改配置
5. 点击提交
6. 表单验证
7. 调用API更新
8. 成功：刷新列表并显示成功提示
9. 失败：显示错误信息

#### 删除预设流程
1. 点击删除按钮
2. 显示确认对话框
3. 用户确认
4. 调用API删除
5. 成功：刷新列表并显示成功提示
6. 失败：显示错误信息

## 5. 技术实现

### 5.1 文件结构

```
frontend/
├── app/
│   └── dashboard/
│       └── provider-presets/
│           └── page.tsx                    # 主页面
├── components/
│   └── dashboard/
│       └── provider-presets/
│           ├── provider-preset-table.tsx   # 表格组件
│           ├── provider-preset-form.tsx    # 表单组件
│           └── provider-preset-dialog.tsx  # 详情对话框
└── http/
    └── provider-preset.ts                  # API客户端
```

### 5.2 API接口映射

| 功能 | 方法 | 端点 | 说明 |
|------|------|------|------|
| 获取列表 | GET | `/provider-presets` | 所有用户可访问 |
| 创建预设 | POST | `/admin/provider-presets` | 仅管理员 |
| 更新预设 | PUT | `/admin/provider-presets/{preset_id}` | 仅管理员 |
| 删除预设 | DELETE | `/admin/provider-presets/{preset_id}` | 仅管理员 |

### 5.3 数据获取策略

使用 SWR 进行数据获取和缓存：

```typescript
const { data, error, isLoading, mutate } = useSWR(
  '/provider-presets',
  providerPresetService.getProviderPresets,
  {
    revalidateOnFocus: false,
    revalidateOnReconnect: true,
  }
);
```

### 5.4 状态管理

- 使用 React useState 管理本地UI状态
- 使用 SWR 管理服务器状态
- 表单状态使用受控组件模式

### 5.5 shadcn/ui 组件使用

| 组件 | 用途 |
|------|------|
| Button | 操作按钮 |
| Dialog | 表单对话框 |
| Table | 数据表格 |
| Input | 文本输入 |
| Select | 下拉选择 |
| Textarea | 多行文本 |
| Tabs | 标签页切换 |
| Label | 表单标签 |
| Badge | 状态标签 |
| Sonner (Toast) | 消息提示 |

## 6. 表单验证规则

### 6.1 客户端验证

- **preset_id**: 
  - 必填
  - 1-50字符
  - 仅允许字母、数字、下划线、连字符
  - 创建时检查唯一性

- **display_name**:
  - 必填
  - 最大100字符

- **base_url**:
  - 必填
  - 有效的HTTP/HTTPS URL格式

- **description**:
  - 可选
  - 最大2000字符

- **路径字段** (models_path, messages_path等):
  - 必须以 `/` 开头
  - 不能为空字符串

- **custom_headers**:
  - 必须是有效的JSON对象

- **static_models**:
  - 必须是有效的JSON数组

### 6.2 服务端验证

后端会进行相同的验证，并返回详细的错误信息。

## 7. 错误处理

### 7.1 错误类型

1. **网络错误**: 显示"网络连接失败，请检查网络"
2. **权限错误**: 显示"您没有权限执行此操作"
3. **验证错误**: 显示具体字段的错误信息
4. **服务器错误**: 显示"服务器错误，请稍后重试"

### 7.2 错误显示方式

- 表单验证错误：字段下方红色文本
- API错误：Toast消息提示
- 加载失败：空状态页面with重试按钮

## 8. 用户体验优化

### 8.1 加载状态
- 列表加载：显示骨架屏
- 按钮操作：按钮显示加载状态并禁用
- 表单提交：提交按钮显示"提交中..."

### 8.2 成功反馈
- 创建成功：Toast提示 + 自动刷新列表
- 更新成功：Toast提示 + 自动刷新列表
- 删除成功：Toast提示 + 自动刷新列表

### 8.3 空状态
- 无数据时显示友好的空状态页面
- 提供"创建第一个预设"的引导

### 8.4 响应式设计
- 移动端：表格转为卡片列表
- 平板端：简化表格列
- 桌面端：完整表格显示

## 9. 安全考虑

1. **权限检查**: 前端检查用户是否为管理员，后端强制验证
2. **输入清理**: 防止XSS攻击，对用户输入进行转义
3. **CSRF保护**: 使用JWT令牌进行身份验证
4. **敏感信息**: 不在前端显示完整的API密钥

## 10. 测试计划

### 10.1 单元测试
- API客户端函数测试
- 表单验证逻辑测试
- 组件渲染测试

### 10.2 集成测试
- 完整的CRUD流程测试
- 错误处理测试
- 权限控制测试

### 10.3 E2E测试
- 用户创建预设流程
- 用户编辑预设流程
- 用户删除预设流程

## 11. 国际化支持

所有文本使用 i18n 键值，支持中英文切换。

## 12. 性能优化

1. **虚拟滚动**: 大量数据时使用虚拟滚动
2. **防抖搜索**: 搜索输入使用防抖
3. **懒加载**: 对话框内容懒加载
4. **缓存策略**: SWR自动缓存和重新验证

## 13. 后续扩展

1. **批量操作**: 支持批量删除预设
2. **导入导出**: 支持JSON格式导入导出预设
3. **预设模板**: 提供常用提供商的预设模板
4. **使用统计**: 显示每个预设被使用的次数
5. **版本控制**: 预设配置的版本历史记录